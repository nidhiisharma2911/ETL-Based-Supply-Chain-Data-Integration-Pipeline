name: Enable Branch Protection (manual)

on:
  workflow_dispatch:

jobs:
  enable-protection:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Enable branch protection for `main` using PAT
        env:
          GH_ADMIN_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          if [ -z "$GH_ADMIN_TOKEN" ]; then
            echo "GH_ADMIN_TOKEN secret is not set. Please add a PAT as repository secret GH_ADMIN_TOKEN."
            exit 1
          fi

          BODY_FILE="protection_body.json"
          cat > "$BODY_FILE" <<'JSON'
{
  "required_status_checks": {"strict": true, "contexts": ["ETL Validation - PR & Push"]},
  "enforce_admins": false,
  "required_pull_request_reviews": {"dismiss_stale_reviews": false, "require_code_owner_reviews": false, "required_approving_review_count": 0},
  "restrictions": null
}
JSON

          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/branches/main/protection"
          echo "Updating branch protection via API: $API_URL"
          http_status=$(curl -sS -o /tmp/resp -w "%{http_code}" -X PUT -H "Authorization: token $GH_ADMIN_TOKEN" -H "Accept: application/vnd.github+json" "$API_URL" -d @$BODY_FILE || true)
          echo "GitHub API response code: $http_status"
          if [ "$http_status" -ge 200 ] && [ "$http_status" -lt 300 ]; then
            echo "Branch protection updated successfully."
            cat /tmp/resp
          else
            echo "Failed to update branch protection. Response:" >&2
            cat /tmp/resp >&2
            exit 1
          fi
